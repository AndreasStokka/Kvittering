name: Xcode - Build, Test and Analyze

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    name: Build, test and analyze Xcode project
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      - name: Get simulator destination
        id: simulator
        run: |
          # Finn første iPhone simulator destination med både name og OS
          DEST=$(xcodebuild -project Kvittering.xcodeproj -scheme Kvittering -showdestinations | grep "iOS Simulator" | grep "iPhone 16" | head -1)
          if [ -z "$DEST" ]; then
            # Fallback: bruk første iPhone simulator
            DEST=$(xcodebuild -project Kvittering.xcodeproj -scheme Kvittering -showdestinations | grep "iOS Simulator" | grep "iPhone" | head -1)
          fi
          if [ -z "$DEST" ]; then
            # Fallback: bruk første iOS Simulator
            DEST=$(xcodebuild -project Kvittering.xcodeproj -scheme Kvittering -showdestinations | grep "iOS Simulator" | head -1)
          fi
          echo "Found destination: $DEST"
          # Parse ut name og OS fra destination string
          NAME=$(echo "$DEST" | sed -n 's/.*name=\([^,]*\).*/\1/p')
          OS=$(echo "$DEST" | sed -n 's/.*OS=\([^,]*\).*/\1/p')
          if [ -n "$NAME" ] && [ -n "$OS" ]; then
            echo "dest=platform=iOS Simulator,name=$NAME,OS=$OS" >> $GITHUB_OUTPUT
          elif [ -n "$NAME" ]; then
            echo "dest=platform=iOS Simulator,name=$NAME" >> $GITHUB_OUTPUT
          else
            # Fallback til hardkodet verdi
            echo "dest=platform=iOS Simulator,name=iPhone 16,OS=18.6" >> $GITHUB_OUTPUT
          fi
      
      - name: Build project
        run: |
          xcodebuild clean build \
            -project Kvittering.xcodeproj \
            -scheme Kvittering \
            -destination "${{ steps.simulator.outputs.dest }}" \
            CODE_SIGNING_ALLOWED=NO
      
      - name: Run tests
        run: |
          xcodebuild test \
            -project Kvittering.xcodeproj \
            -scheme Kvittering \
            -destination "${{ steps.simulator.outputs.dest }}" \
            CODE_SIGNING_ALLOWED=NO
      
      - name: Analyze project
        run: |
          xcodebuild analyze \
            -project Kvittering.xcodeproj \
            -scheme Kvittering \
            -destination "${{ steps.simulator.outputs.dest }}" \
            CODE_SIGNING_ALLOWED=NO || true
